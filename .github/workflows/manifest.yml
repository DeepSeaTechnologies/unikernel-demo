name: Manifest

on:
  workflow_call:
    inputs:
      unikernel:
        required: true
        type: string
      hypervisor:
        required: true
        type: string
    secrets:
      harbor_secret:
        required: true
      harbor_user:
        required: true
      cosign_private_key:
        required: true
      cosign_password:
        required: true  

permissions:
  id-token: write # This is required for requesting the JWT
  contents: read  # This is required for actions/checkout


jobs:
  manifest:
    runs-on: ubuntu-latest
    steps:

    - name: Install Cosign
      uses: sigstore/cosign-installer@v3.5.0

    - name: Login to Harbor
      uses: docker/login-action@v2
      with:
        registry: c8n.io/bmutziu
        username: ${{ secrets.harbor_user }}
        password: ${{ secrets.harbor_secret }}

    - name: Check install!
      run: cosign version

    - name: Create manifest
      run: |
        TAGS=c8n.io/bmutziu/${{ inputs.unikernel }}-${{ inputs.hypervisor }}:latest
        docker manifest rm $TAGS || true
        docker manifest create $TAGS \
           --amend c8n.io/bmutziu/${{ inputs.unikernel }}-${{ inputs.hypervisor }}:x86_64
        HASH=$(docker manifest push $TAGS)
        echo "hash=$HASH" >> $GITHUB_ENV
        echo "tags=$TAGS" >> $GITHUB_ENV

    - name: Sign the published Docker image
      env:
        DIGEST: ${{ env.hash }}
        TAGS: ${{ env.tags }}
        COSIGN_PRIVATE_KEY: ${{ secrets.cosign_private_key }}
        COSIGN_PASSWORD: ${{ secrets.cosign_password }}
      run: |
        cosign sign --yes --key env://COSIGN_PRIVATE_KEY c8n.io/bmutziu/${{ inputs.unikernel }}-${{ inputs.hypervisor }}:x86_64@${{ env.DIGEST }} \
        -a "repo=${{github.repository}}" \
        -a "workflow=${{github.workflow}}" \
        -a "ref=${{github.sha}}" \
        -a "author=Nubificus LTD"
